# See repository policies at ../../REPO_POLICIES.md
# ===========================================================================
# GitHub Repository Issue Management Policy
# ===========================================================================
# Purpose: Automate issue workflow management for this repository
# This policy handles issue creation, triage, labeling, and lifecycle management
id: 
name: GitOps.PullRequestIssueManagement
description: Defines handlers for various issue events, primarily focusing on newly opened issues and their lifecycle
owner: Arc Jumpstart
resource: repository
disabled: false
where:
configuration:
  resourceManagementConfiguration:
    # ===========================================================================
    # EVENT RESPONDER TASKS
    # Defines automated actions triggered by specific GitHub events
    # These tasks create a streamlined workflow for issue management
    # ===========================================================================

    eventResponderTasks:
      # ---------------------------------------------------------------------------
      # NEW ISSUE MANAGEMENT
      # Handles initial triage and labeling of new issues
      # Automatically categorizes issues to improve visibility and tracking
      # ---------------------------------------------------------------------------
      - description: If an issue title contains "bug" upon opening, add the "Bug-Issue" label if not already present
        if:
          - payloadType: Issues
          - isAction:
              action: Opened
          - titleContains:
              pattern: "(?i)bug"
              isRegex: true
          - not:
              hasLabel:
                  label: Bug-Issue
        then:
          - addLabel:
              label: Bug-Issue

      - description: If an issue title contains "feature" upon opening, add the "Feature-Request" label if not already present
        if:
          - payloadType: Issues
          - isAction:
              action: Opened
          - titleContains:
              pattern: "(?i)feature"
              isRegex: true
          - not:
              hasLabel:
                  label: Feature-Request
        then:
          - addLabel:
              label: Feature-Request

      - description: If an issue title contains "arcbox" upon opening, add the "ArcBox" label if not already present
        if:
          - payloadType: Issues
          - isAction:
              action: Opened
          - titleContains:
              pattern: "(?i)arcbox"
              isRegex: true
          - not:
              hasLabel:
                  label: ArcBox
        then:
          - addLabel:
              label: ArcBox

      - description: If an issue title contains "localbox" upon opening, add the "LocalBox" label if not already present
        if:
          - payloadType: Issues
          - isAction:
              action: Opened
          - titleContains:
              pattern: "(?i)localbox"
              isRegex: true
          - not:
              hasLabel:
                  label: LocalBox
        then:
          - addLabel:
              label: LocalBox

      - description: If an issue title contains "hcibox" upon opening, add the "LocalBox" label if "HCIBox" is not already present
        if:
          - payloadType: Issues
          - isAction:
              action: Opened
          - titleContains:
              pattern: "(?i)hcibox"
              isRegex: true
          - not:
              hasLabel:
                  label: HCIBox
        then:
          - addLabel:
              label: LocalBox

      - description: If an issue title contains "agora" upon opening, add the "Agora" label if not already present
        if:
          - payloadType: Issues
          - isAction:
              action: Opened
          - titleContains:
              pattern: "(?i)agora"
              isRegex: true
          - not:
              hasLabel:
                  label: Agora
        then:
          - addLabel:
              label: Agora

      - description: Close issues opened without "Bug-Issue" or "Feature-Request" labels, and add the "Abandoned" label
        if:
          - payloadType: Issues
          - isAction:
              action: Opened
          - and:
              - not:
                  hasLabel:
                      label: Bug-Issue
              - not:
                  hasLabel:
                      label: Feature-Request
        then:
            - addReply:
                reply: |
                    👋 Hello ${issueAuthor},

                    This issue does not appear to have been submitted using our GitHub Issue Forms, or the required labels ('Bug-Issue' or 'Feature-Request') are missing. All issues must be submitted using our forms to ensure they are categorized correctly.

                    This issue will now be closed. Please resubmit your issue or feature request [using the appropriate template](https://github.com/microsoft/azure_arc/issues/new/choose).

                    Thank you for your collaboration!
            - addLabel:
                label: Abandoned                    
            - closeIssue

      - description: Add the "Needs-Triage" label and a welcome comment to new, valid issues (those with "Bug-Issue" or "Feature-Request" labels) that are not yet triaged or abandoned
        if:
          - payloadType: Issues
          - isAction:
              action: Opened
          - or:
              - hasLabel:
                  label: Bug-Issue
              - hasLabel:
                  label: Feature-Request
          - not: 
              hasLabel: # Avoid re-labeling if already triaged
                  label: Needs-Triage
          - not: # Ensure this rule doesn't apply if the issue was just abandoned
              hasLabel:
                  label: Abandoned
        then:
            - addLabel:
                label: Needs-Triage
            - addReply:
                reply: |
                    👋 Hello ${issueAuthor},

                    Thank you for reporting this issue a team member will review and triage it soon. All issues and pull requests are evaluated by the Arc Jumpstart team to determine next steps.

                    By submitting this issue request, you agree that your contributions will be licensed under the project's [MIT license](https://github.com/microsoft/azure_arc/blob/main/LICENSE-CODE) and you confirm that you've read and will abide by our [Code of Conduct](https://github.com/microsoft/azure_arc/blob/main/CODE_OF_CONDUCT.md).

                    Thank you for your collaboration!




      # ---------------------------------------------------------------------------
      # ISSUE LIFECYCLE MANAGEMENT
      # Handles issue closing, reopening, and duplicate detection
      # Creates a consistent workflow for issue resolution
      # ---------------------------------------------------------------------------
      - description: When an issue is closed, remove workflow labels ("Needs-Triage", "Needs-Attention", "Needs-Author-Feedback"), add "Issue-Addressed", and post a comment
        # Auto-cleanup - removes working labels and adds the "Issue-Addressed" label
        # This keeps the label system clean and meaningful
        triggerOnOwnActions: false
        if:
        - payloadType: Issues
        - isAction:
            action: Closed
        then:
        # Remove all workflow labels as they're no longer needed
        - removeLabel:
            label: Needs-Triage
        - removeLabel:
            label: Needs-Attention
        - removeLabel: 
            label: Needs-Author-Feedback    
        # Mark as addressed for tracking metrics by adding the "Issue-Addressed" label
        - addLabel:
            label: Issue-Addressed
        - addReply:
            reply: |
                👋 Hello ${issueAuthor},

                We've closed this issue because it has been addressed. If you believe further discussion is needed, please add a comment "`/unresolve`" to reopen the issue.

                Thank you for your collaboration!

      - description: Reopen unresolved issues by removing resolution labels, adding "Needs-Author-Feedback", posting a comment, and reopening the issue
        # Triggered by the keyword "/unresolve" in comments
        # Allows authors to reopen issues for further discussion by adding the "Needs-Author-Feedback" label
        triggerOnOwnActions: false
        if:
        - payloadType: Issue_Comment
        - and:
            - commentContains:
                pattern: "(?i)unresolve"
                isRegex: true
        then:
        # Remove resolution labels to indicate unresolved status
        - removeLabel:
            label: Issue-Addressed
        - removeLabel:
            label: Resolution-Duplicate
        - removeLabel:
            label: No-Recent-Activity
        # Mark for author feedback by adding the "Needs-Author-Feedback" label
        - addLabel:
            label: Needs-Author-Feedback
        - addReply:
            reply: |
                👋 Hello ${issueAuthor},

                We've reopened this issue because you marked it as unresolved. We need more information from you or we identified it is not completely resolved.

                Thank you for your collaboration!

        - reopenIssue

      - description: Add the "Needs-Triage" label and a comment to reopened issues that are not assigned to anyone
        # Ensures unassigned reopened issues get proper attention from maintainers by adding the "Needs-Triage" label
        triggerOnOwnActions: false
        if:
        - payloadType: Issues
        - isAction:
            action: Reopened
        - not:
            isAssignedToSomeone
        then:
        # Clear resolution labels when an issue is reopened
        - removeLabel:
            label: Issue-Addressed
        - removeLabel:
            label: Resolution-Duplicate
        - removeLabel:
            label: Missing-Milestone
        # Mark for triage by adding the "Needs-Triage" label
        - addLabel:
            label: Needs-Triage
        - addReply:
            reply: |
                👋 Hello ${issueAuthor},

                We've reopened this issue because we need more information from you or we identified it is not completely resolved.

                Thank you for your collaboration!

      - description: Add the "Needs-Attention" label and a comment to reopened issues that are already assigned
        # Ensures assigned reopened issues get proper attention from maintainers by adding the "Needs-Attention" label
        triggerOnOwnActions: false
        if:
        - payloadType: Issues
        - isAction:
            action: Reopened
        - isAssignedToSomeone
        then:
        # Clear resolution labels when an issue is reopened
        - removeLabel:
            label: Issue-Addressed
        - removeLabel:
            label: Resolution-Duplicate            
        # Mark for team attention by adding the "Needs-Attention" label
        - addLabel:
            label: Needs-Attention
        - addReply:
            reply: |
                👋 Hello ${issueAuthor},

                We've reopened this issue because we need more information from you or we identified it is not completely resolved

                Thank you for your collaboration!

      # ---------------------------------------------------------------------------
      # ISSUE ASSIGNMENT HANDLING
      # Manages labels when issues are assigned or unassigned
      # ---------------------------------------------------------------------------
      - description: Remove the "Needs-Triage" label when an issue is assigned, if it has the label
        # This rule ensures that once an issue is assigned, it's no longer in the general triage pool
        if:
          - payloadType: Issues
          - and:
              - isAction:
                  action: Assigned # This rule relies on the 'Assigned' action being supported
              - hasLabel:
                  label: Needs-Triage
        then:
          - removeLabel:
              label: Needs-Triage

      - description: Add "Needs-Triage" to open, unassigned, non-abandoned issues that do not already have it
        # This rule ensures that all open issues that are not assigned to someone, not abandoned, and not already triaged are marked for triage
        if:
          - payloadType: Issues
          - isOpen
          - not:
              isAssignedToSomeone 
          - not:
              hasLabel:
                  label: Abandoned
          - not:
              hasLabel: # Added to prevent redundant adds
                  label: Needs-Triage
        then:
          - addLabel:
              label: Needs-Triage

      - description: Handle cases where "Needs-Triage" is manually added to an open, assigned issue by removing "Needs-Triage" and adding "Needs-Attention"
        # This rule corrects instances where "Needs-Triage" might be inappropriately added to an assigned issue, redirecting it to "Needs-Attention"
        if:
          - payloadType: Issues
          - isOpen
          - and:
              - hasLabel:
                  label: Needs-Triage
              - isAssignedToSomeone
        then:
          - removeLabel:
              label: Needs-Triage
          - addLabel:
              label: Needs-Attention

      - description: Add the "Needs-Attention" label to open, assigned issues that do not already have it
        # This rule ensures that all open issues assigned to someone are appropriately marked for attention if not already
        if:
          - payloadType: Issues
          - isOpen        
          - and:
             - not:
                hasLabel:
                    label: Needs-Attention
          - isAssignedToSomeone
        then:
          - addLabel:
              label: Needs-Attention

      # ---------------------------------------------------------------------------
      # DUPLICATE ISSUE HANDLING
      # Manages issues identified as duplicates in comments
      # Streamlines issue tracking by consolidating duplicates
      # ---------------------------------------------------------------------------
      - description: If a comment identifies an issue as a duplicate, add the "Resolution-Duplicate" label, post a comment, and close the issue
        # This rule detects comments containing variations of the word "duplicate" and marks the issue accordingly
        triggerOnOwnActions: false
        if:
        - payloadType: Issue_Comment
        - and:
            # Look for various forms of "duplicate" in comments
            - commentContains:
                pattern: "(?i)duplicat(e|ed|ing)?"
                isRegex: true
        then:
        - addReply:
            reply: |
                ⚠️ **WARNING: Duplicate Issue** ⚠️
                
                👋 Hello ${issueAuthor},

                We've identified this as a duplicate of another issue or PR that already exists. This specific instance is being closed in favor of the linked issue. Please add your 👍 to the other issue to raise its priority.

                Thank you for your collaboration!

        - closeIssue
        # Remove all working labels
        - removeLabel:
            label: Needs-Triage
        - removeLabel:
            label: Needs-Attention
        - removeLabel:
            label: Needs-Feedback-Hub
        - removeLabel:
            label: Needs-Author-Feedback
        # Add the "Resolution-Duplicate" label
        - addLabel:
            label: Resolution-Duplicate

      # ---------------------------------------------------------------------------
      # ISSUE MILESTONE CHECK
      # Labels issues that are assigned or closed without a milestone by adding the "Missing-Milestone" label
      # ---------------------------------------------------------------------------
      - description: Add the "Missing-Milestone" label to assigned issues without a milestone, if not already present
        # This rule helps ensure all assigned issues are tracked with a milestone by adding the "Missing-Milestone" label if needed
        if:
        - payloadType: Issues
        - isAssignedToSomeone
        - not:
            isPartOfAnyMilestone
        - not: # Prevent adding if already present
            hasLabel:
                label: Missing-Milestone
        then:
        - addLabel:
            label: Missing-Milestone

      - description: Add the "Missing-Milestone" label to closed issues without a milestone, if not already present
        # This rule helps ensure all closed issues are tracked with a milestone by adding the "Missing-Milestone" label if needed
        if:
        - payloadType: Issues
        - isAction:
            action: Closed
        - not:
            isPartOfAnyMilestone
        - not: # Prevent adding if already present
            hasLabel:
                label: Missing-Milestone
        then:
        - addLabel:
            label: Missing-Milestone

      - description: Remove the "Missing-Milestone" label if an issue has both this label and a milestone
        # This rule attempts to remove the "Missing-Milestone" label if an issue is found to have both the label and an actual milestone
        # Relies on the policy engine re-evaluating rules on general issue updates, as a specific 'Milestoned' action might not be supported
        if:
        - payloadType: Issues
        - hasLabel:
            label: Missing-Milestone
        - isPartOfAnyMilestone
        then:
        - removeLabel:
            label: Missing-Milestone

    # ===========================================================================
    # SCHEDULED SEARCHES
    # Periodic tasks that run on defined schedules to maintain repository hygiene
    # ===========================================================================
    scheduledSearches:

    # ---------------------------------------------------------------------------
    # ISSUE MILESTONE CHECKS (Scheduled)
    # Periodically ensures the "Missing-Milestone" label is correctly applied or removed
    # ---------------------------------------------------------------------------
    - description: Periodically remove the "Missing-Milestone" label from open issues that have it but are also part of a milestone
      # This scheduled task acts as a cleanup for cases where an issue has a milestone but also incorrectly has the "Missing-Milestone" label
      # It runs every hour
      frequencies:
      - hourly:
          hour: 1 
      filters:
      - isIssue
      - isOpen # Only consider open issues
      - hasLabel: # Ensure the label to be removed is present
          label: Missing-Milestone
      - isNotPartOfMilestone: # This filter, using 'isNotPartOfMilestone' with an 'INVALID' milestone, is a technique used here to effectively check if the issue is part of any actual milestone
                milestone: INVALID # An intentionally non-existent milestone name
      actions:
      - removeLabel:
          label: Missing-Milestone

    - description: Periodically add the "Missing-Milestone" label to open, unmilestoned issues marked "Needs-Attention" and "Bug-Issue", if the label is not already present
      # This scheduled task targets specific open issues (likely considered assigned or important due to "Needs-Attention" and "Bug-Issue" labels) that lack a milestone, ensuring they are correctly flagged
      # It runs every hour
      frequencies:
      - hourly:
          hour: 1
      filters:
      - isIssue
      - isOpen # Only consider open issues
      - isNotInAnyMilestone # Ensure the issue does not have a milestone
      - hasLabel: # Check for "Needs-Attention" label
          label: Needs-Attention
    #   - hasLabel: # Check for "Bug-Issue" label
    #       label: Bug-Issue
      - isNotLabeledWith: # Ensure "Missing-Milestone" is not already present
            label: Missing-Milestone
      actions:
      - addLabel:
          label: Missing-Milestone

    # - description: Periodically add the "Missing-Milestone" label to open, unmilestoned issues marked "Needs-Attention" and "Feature-Request", if the label is not already present
    #   # This scheduled task targets specific open issues (likely considered assigned or important due to "Needs-Attention" and "Feature-Request" labels) that lack a milestone, ensuring they are correctly flagged
    #   # It runs every hour
    #   frequencies:
    #   - hourly:
    #       hour: 1
    #   filters:
    #   - isIssue
    #   - isOpen # Only consider open issues
    #   - isNotInAnyMilestone # Ensure the issue does not have a milestone
    #   - hasLabel: # Check for "Needs-Attention" label
    #       label: Needs-Attention
    #   - hasLabel: # Check for "Feature-Request" label
    #       label: Feature-Request           
    #   - isNotLabeledWith: # Ensure "Missing-Milestone" is not already present
    #         label: Missing-Milestone
    #   actions:
    #   - addLabel:
    #       label: Missing-Milestone

    # ---------------------------------------------------------------------------
    # STALE ISSUE MANAGEMENT
    # Automatically closes issues that need feedback but have no activity
    # ---------------------------------------------------------------------------
    - description: Close stale issues - issues labeled "Needs-Author-Feedback" and "No-Recent-Activity" with no activity for 7 days (excluding "Feature-Request" and "Upstream-Bug-Issue" types)
      # This runs every hour and closes issues after the warning period has elapsed
      frequencies:
      - hourly:
          hour: 1
      filters:
      # Only target issues that are open and need author feedback
      # Exclude issues that are labeled with the "Feature-Request" label or the "Upstream-Bug-Issue" label   
      - isIssue
      - isOpen
      - hasLabel:
          label: Needs-Author-Feedback
      - hasLabel:
          label: No-Recent-Activity
      - isNotLabeledWith:
          label: Feature-Request
      - isNotLabeledWith:
          label: Upstream-Bug-Issue             
      - noActivitySince:
          days: 7
      actions:
      - closeIssue
      # Add the "Close-Stale" label for tracking
      - addLabel:
          label: Close-Stale
      # Remove the "Needs-Triage" label as it's no longer needed
      - removeLabel:
          label: Needs-Triage

    - description: Add the "No-Recent-Activity" label and a warning comment to issues needing author feedback with no activity for 7 days
      # This runs every hour and adds the "No-Recent-Activity" label to issues that have not had any activity for 7 days and require author feedback
      # This is the first warning stage before closing stale issues
      # Timeline: Day 7 - Add warning label, Day 14 - Close issue if no response
      frequencies:
      - hourly:
          hour: 1
      filters:
        # Only target issues that are open and need author feedback
      - isIssue
      - isOpen
      - hasLabel:
          label: Needs-Author-Feedback
      - noActivitySince:
          days: 7
      - isNotLabeledWith:
          label: No-Recent-Activity
      actions:
      # Mark as inactive by adding the "No-Recent-Activity" label
      - addLabel:
          label: No-Recent-Activity
      # Notify author with clear timeline for resolution
      - addReply:
          reply: |
                👋 Hello ${issueAuthor},

                We're sending this friendly reminder because we haven't heard back from you in a while and we need more information about this issue to help address it. Please be sure to give us your input within the next **7 days**. If we don't hear back from you within **7 days** of this comment the issue will be automatically closed.

                Thank you for your collaboration!

    - description: Close issues labeled "Issue-Addressed" with no activity for 7 days, after a final notification
      # This runs every hour and closes issues labeled "Issue-Addressed" that have had no activity for 7 days
      # Auto-closes resolved issues after a waiting period for any objections
      frequencies:
      - hourly:
          hour: 1
      filters:
        # Only target issues that are open and have been addressed
      - isIssue
      - isOpen
      - hasLabel:
          label: Issue-Addressed
      - noActivitySince:
          days: 7
      actions:
      # Final notification before closure
      - addReply:
          reply: |
                👋 Hello ${issueAuthor},
                
                Since you haven't asked that we "`/unresolve`" the issue, we'll close this out. If you believe further discussion is needed, please add a comment "`/unresolve`" to reopen the issue.

                Thank you for your collaboration!

      # Close the issue after waiting period
      - closeIssue

# ---------------------------------------------------------------------------
# ERROR HANDLING CONFIGURATION
# Defines what happens when policy execution succeeds or fails
# ---------------------------------------------------------------------------
onFailure:
  # Can be configured to notify admins or log errors
onSuccess:
  # Can be configured to perform actions upon successful execution